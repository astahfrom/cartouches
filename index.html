<!DOCTYPE html>
<html>

<head>
    <title>Isabelle Snippets</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
</head>

<body>
    <script type="module">
        import init, { extract_snippets } from './pkg/cartouches.js';

        async function run() {
            await init();
        }

        run();

        function updateInput() {
            document.getElementById("uploadInput").value = "";
            const input = document.getElementById("input").value;
            const snips = extract_snippets(input, "");
            document.getElementById("output").value = snips;
        }

        async function updateUpload() {
            document.getElementById("input").value = "";
            document.getElementById("output").value = "";

            let files = this.files;
            for (let fId = 0; fId < files.length; fId++) {
                const file = files[fId];
                const name = file.name;
                let theory = "";
                if (files.length > 1) {
                    theory = name.substring(0, name.length - 4);
                }
                const text = await file.text();
                const snips = extract_snippets(text, theory);
                document.getElementById("output").value += snips;
            }
        }

        function copyToClipboard() {
            var copyText = document.querySelector("#output");
            copyText.select();
            document.execCommand("copy");
        }

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        function downloadOutput() {
            const text = document.getElementById("output").value;
            download("snips.tex", text);
        }

        window.addEventListener('DOMContentLoaded', (event) => {
            document.getElementById("input").addEventListener("input", updateInput, false);
            document.getElementById("uploadInput").addEventListener("change", updateUpload, false);
            document.getElementById("clipboard").addEventListener("click", copyToClipboard, false);
            document.getElementById("download").addEventListener("click", downloadOutput, false);
        });
    </script>

    <style>
        body {
            font-size: larger;
        }

        div {
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        textarea {
            width: 45%;
            height: auto;
        }
    </style>

    <h1>Isabelle Snippets &mdash; Standalone LaTeX for your formal development</h1>

    <div id="texts">
        <textarea name="input" id="input" rows="20" cols="120"></textarea>

        <textarea name="output" id="output" rows="20" cols="120" readonly></textarea>
    </div>

    <p>
        Make snippets from LaTeX files:
        <input type="file" accept=".tex" name="texFiles" id="uploadInput" multiple>
    </p>
    <p>
        Copy snippets to clipboard:
        <button id="clipboard">Copy!</button>
    </p>
    <p>
        Save snippets:
        <button id="download">Save!</button>
    </p>

    <h2>Information</h2>
    <p>
        The following command in the terminal makes the proof assistant Isabelle generate LaTeX code for the theories in
        the current directory:
    <pre>isabelle build -D . -o document=pdf -o document_output=output</pre>
    Note that this requires a ROOT file in that directory.
    Such a file can be generated by <code>isabelle mkroot</code> (but must be adjusted afterwards).
    </p>
    <p>
        For each theory <code>T.thy</code>, the command generates a LaTeX file <code>output/document/T.tex</code>.
        This webpage takes such LaTeX files and chops them into pieces.
        One can either copy/paste the LaTeX of a single theory in the text area to the left or upload multiple files.
        The results are displayed to the right.
    </p>
    <p>
        This process makes it possible to include only the desired parts of the theory when writing a paper: that
        cartouche
        containing a crucial definition or lines 2-5 of that important proof.
    </p>
    <p>
        The LaTeX code can also be used when collaborating on sites like Overleaf to easily include Isabelle code in
        papers with multiple authors.
    </p>

    <h2>Required LaTeX</h2>
    <p>
        The tool generates a number of <code>\SNIP{name}{body}</code> commands where the names have the following shape:
    <pre>[Theory:]cmd:name[-no]-line[-cartouche]</pre>
    <ul>
        <li><code>theory</code> is added when snippets are generated for more than one theory.</li>
        <li><code>cmd</code> corresponds to the Isabelle command, e.g. "lemma" or "definition".</li>
        <li><code>name</code> is a best guess at identifying the snippet.
            In most cases it will be the name following the Isabelle command, e.g. "f" in "fun f ...".
            Symbols like &phi; (<code>\&lt;phi&gt;</code>) are converted to their name ("phi") and underscores are
            replaced by
            hyphens.
            If the tool cannot guess a name, e.g. for anonymous corollaries, it uses a hash of the Isabelle code.
            This remains the same as long as the Isabelle code for that particular snippet is not changed.
        </li>
        <li><code>no</code> is added when the snippet name would not otherwise be unique. This can especially happen
            when a name cannot be guessed.</li>
        <li><code>line</code> specifies the line of the snippet starting from 0.</li>
        <li><code>cartouche</code> is a number, starting from 0, used to retrieve only that cartouche on the specified
            line.</li>
    </ul>
    </p>
    <p>
        To use the snippets you must include the <code>*.sty</code> files from <code>output/document/</code> in your own
        LaTeX directory.
    </p>

    <h3>Recommended</h3>
    <p>
        The following LaTeX code is recommended.
        In particular, the tool outputs <code>\SNIP</code> and <code>\Cartouche</code> commands that must be defined to
        use the snippets.
    <pre>
\usepackage{isabelle, isabellesym}
\isabellestyle{it} % optional
\newcommand{\SNIP}[2]{\expandafter\newcommand\csname snippet--#1\endcsname{#2}}
\input{snips} % assuming the snippets are saved as snips.tex

% \GetSnip{name} gets the snippet defined by `name' or produces a warning that it does not exist.
\newcommand{\GetSnip}[1]{%
    \ifcsname snippet--#1\endcsname%
        \csname snippet--#1\endcsname%
    \else%
        \PackageWarning{snips}{Snippet ``#1'' is undefined.}%
        \emph{Warning: Snippet ``#1'' is undefined.}%
    \fi%
}

% \RawCartouche{name}{line}{n}: content of cartouche `n' on line `line' of snippet `name'
\newcommand{\RawCartouche}[3]{\GetSnip{#1-#2-#3}}

% \Cartouche{name}{line}{n}: enclosed cartouche `n' on line `line' of snippet `name'
\newcommand{\Cartouche}[3]{%
    {\isacartoucheopen}%
    \RawCartouche{#1}{#2}{#3}%
    {\isacartoucheclose}%
}
</pre>

    The LaTeX error "Command \guilsinglright unavailable in encoding OT1." can be fixed by also adding
    <code>\usepackage[T1]{fontenc}</code>.
    </p>

    <h3>As desired</h3>
    <p>
        The following LaTeX code can be useful:
    <pre>
% \Snippet{name}: the full snippet `name'
\newcommand{\Snippet}[1]{{%
  \newcount\i
  \i=0
  \loop
    \GetSnip{#1-\the\i}
    \advance \i 1
  \ifcsname snippet--#1-\the\i\endcsname
  \repeat
}}

% \SnippetPart{n}{m}{name}: the snippet `name' from line `n' to line `m' inclusive
\newcommand{\SnippetPart}[3]{{%
  \newcount\i
  \i=#1
  \loop
    \ifnum \i=#2
      \renewcommand{\isanewline}{}%
    \fi
    \GetSnip{#3-\the\i}
    \advance \i 1
    \ifnum \i>#2 {}
    \else \repeat
}}
        </pre>
    </p>

    <h3>In some cases</h3>
    <p>
        The following code can be necessary to make the snippets work with some document classes.
    <pre>
\def\isadelimtheory{}\def\endisadelimtheory{}
\def\isatagtheory{}\def\endisatagtheory{}
\def\isadelimML{}\def\endisadelimML{}
\def\isadelimdocument{}\def\endisadelimdocument{}
\def\isatagML{}\def\endisatagML{}
\def\isatagdocument{}\def\endisatagdocument{}
\def\isafoldML{}
\def\isadelimproof{}\def\endisadelimproof{}
\def\isatagproof{}\def\endisatagproof{}
\def\isafoldproof{}
    </pre>
    </p>

    <h3>Example</h3>
    <p>
        Take the following Isabelle theory as example:
    <pre>
theory Scratch imports Main begin

lemma myConjI: ‹P ⟹ Q ⟹ P ∧ Q›
  ..

end
        </pre>

    To include the whole lemma with proof in your paper you can use:
    <pre>
\begin{isabelle}
  \Snippet{lemma:myConjI}
\end{isabelle}
        </pre>

    To include just the first line of the lemma:
    <pre>
\begin{isabelle}
  \SnippetPart{0}{0}{lemma:myConjI}
\end{isabelle}
        </pre>

    Or to include just the contents of the cartouche (<code>P ⟹ Q ⟹ P ∧ Q</code>):
    <pre>
\begin{isabelle}
  \RawCartouche{lemma:myConjI}{0}{0}
\end{isabelle}
        </pre>
    </p>

    <h2>Disclaimer</h2>
    <p>
        This tool was built for Isabelle 2022 and may not support the LaTeX output of other versions.
        The processing of the LaTeX is ad hoc and may result in unexpected behaviour, especially regarding the names of
        snippets.
    </p>
    <p>
        The tool reduces duplication, to save space in the final output, by trying to replace the cartouches on each
        line with a
        <code>\Cartouche</code> command that references the <code>\SNIP</code> for that cartouche.
        However, it can only do so for cartouches without newlines: those that contain newlines are left in place.
    </p>
    <p>
        This means that every cartouche is not necessarily inserted by the <code>\Cartouche</code> macro.
        In particular, to modify the delimiters around cartouches that are inserted via <code>\Snippet</code> and
        <code>\SnippetPart</code> it is safest to use code like <code>\renewcommand{\isacartoucheopen}{...}</code>.
        Depending on the Isabelle code, it may not be enough to modify the definition of <code>\Cartouche</code>.
    </p>

    <h2>Limitations</h2>
    <p>
        The tool assumes that the Isabelle theories use the ‹› cartouche delimiters, not the older double quotes.

        See <a href="https://isabelle.in.tum.de/doc/system.pdf#section.2.7">Section 2.7 of the Isabelle System
            Manual</a>
        for how to update your theory file accordingly.

        Alternatively, to update a single theory using Isabelle/jEdit, search for <code>"([^"]+)"</code> and replace it
        with
        <code>‹$1›</code>.
        Some manual cleanup is likely necessary afterwards.
    </p>
    <p>
        The source code is available on GitHub: <a
            href="https://github.com/astahfrom/cartouches">astahfrom/cartouches</a>.
    </p>

    <h2>Author</h2>
    <p>
        Asta Halkjær From.
        Github: <a href="https://github.com/astahfrom/">github.com/astahfrom/</a>
    </p>

</body>

</html>